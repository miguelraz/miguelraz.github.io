<!doctype html> <html lang=en > <meta charset=UTF-8 > <meta name=viewport  content="width=device-width, initial-scale=1"> <!--<link rel=stylesheet  href="/libs/highlight/github.min.css"> --> <link rel=stylesheet  href="/libs/highlight/styles/atom-one-dark.css"> <script src="libs/clipboard.min.js"></script> <link rel=stylesheet  href="/css/franklin.css"> <link rel=stylesheet  href="/css/basic.css"> <link rel=icon  href="/assets/favicon.ico" type="image/x-icon"> <title>GSoC in LLVM 2024</title> <header> <div class=blog-name ><a href="">PathToPerformance</a></div> <nav> <ul> <li><a href="/">Welcome! üëãüèæ</a> <li><a href="/diary/">Diaryüìí</a> <li><a href="/blog/">Blogüí≠</a> <li><a href="/pubs/">Publications üìì /Talksüó£Ô∏è /Videosüé• </a> <li><a href="/teaching/">Teachingüéì/Translationsüó∫Ô∏è</a> <li><a href="/about/">CVüíÉ</a> <script src="/libs/clipboard.js"></script> </ul> <img src="/assets/hamburger.svg" id=menu-icon > </nav> </header> <div class=franklin-content ><h1 id=im_trying_to_get_a_gsoc_2024_in_llvm ><a href="#im_trying_to_get_a_gsoc_2024_in_llvm" class=header-anchor >I&#39;m trying to get a GSoC 2024 in LLVM</a></h1> <p>and I will be documenting my work with this ongoing blogpost in reverse chronological order.</p> <hr /> <p>If you want to see more posts like this, consider chucking a buck or two on my <a href="https://github.com/miguelraz">GitHub sponsors</a>, or, you know, hire me as a grad student.</p> <hr /> <h2 id=13022024 ><a href="#13022024" class=header-anchor >13/02/2024 </a></h2> <p>OK, I just saw that both Nikita Popov and Dhruv Chawla are listed as mentors for the project. Should try and reach out before the application period begins.</p> <p>Nikita commented that there&#39;s two good places to look into &#40;which I should do meanwhile&#41;:</p> <ul> <li><p>The <a href="https://llvm.org/docs/CodeGenerator.html#instruction-selection-section">Selection DAG part of the manual</a></p> <li><p>The good first issues on the github tracker, which probably are good to look into.</p> </ul> <h3 id=notes_on_the_selectiondag ><a href="#notes_on_the_selectiondag" class=header-anchor >Notes on the SelectionDAG </a></h3> <ul> <li><p>GlobalISel and SelectionDAG both translated LLVM code to target specific machine instructions.</p> <li><p>In theory Intrinsics.td should handle it all but some parts need custo C&#43;&#43; code.</p> <li><p>SDAGs represent Machine Value Types and DataFlow types. Dataflow types provide ordering.</p> <li><p>Legal vs illegal DAG: only use supported ops on supported types </p> <li><p>SDAG phases: build, optimize, legalizeTypes, optimize, legalize, select instructions, scheduling</p> <ul> <li><p>common to use <code>-debug-only&#61;isel/-dump</code> and <code>-filter-print-funcs&#61;&lt;function-name&gt;</code></p> <li><p>several flags can print SDAG after each pass </p> </ul> <li><p>OK, effective sign extension elimination seems to be highly non-trivial optimizations</p> <li><p>Oohhhh TableGen representing stuff as a DAG lets you build the SelectionDAG on top of it&#33;</p> </ul> <p>After a few hours of noodling with PR reviews, it&#39;s clear I gotta jump on a next one/help PR review some other people. Maybe it&#39;s not great to go full mercenary on every <code>good-first-issue</code> and try and help others along the way.</p> <p><code>ParticleSwarmOptimization</code> was kind enough in the <code>LLVM/beginners</code> Discord chat to point out that I should have a full build of LLVM and then run <code>llvm-lit</code> from there on a unit test. Sure enough, that let me do <code>gh pr checkout 84903</code> and then <code>LIT llvm/test/CodeGen/AArch64/hadd-combine.ll</code> to check that a unit test properly ran. Now I can help verify my own and other people&#39;s PRs&#33; yay&#33;</p> <p>That seems like enough for today, I&#39;ll hunt for some good issues tomorrow.</p> <h2 id=12022024 ><a href="#12022024" class=header-anchor >12/02/2024 </a></h2> <p>Did a bunch of very quick fixes and got some neat feedback.</p> <h2 id=11022024 ><a href="#11022024" class=header-anchor >11/02/2024 </a></h2> <p>Ohhhhhh neat&#33; Got some really fast feedback this time around on stray newlines and a couple fixes on the PR. Things are moving faster and faster&#33; I <em>think</em> I&#39;m only missing adding some <code>FileCheck</code> tests for the invariants under the <code>Verifier.cpp</code> stuff that isn&#39;t handled by <code>Intrinsics.td</code> but that sounds about it&#33;</p> <p><a href="https://llvm.org/docs/CommandGuide/FileCheck.html">FileCheck</a> reading I&#39;ll do for a bit.</p> <p>Note: If you are going to check multiple things in a single file, use a <code>CHECK-LABEL</code> to avoid spurious matches.</p> <p>Sometimes, a <code>CHECK-NEXT</code> is useful as the last unit test. </p> <p>Learned the LLVMIR verbose call syntax goes &#40;gotta include types in call site&#41;.</p> <p>That should do it for today, see y&#39;all tomorrow.</p> <h2 id=10022024 ><a href="#10022024" class=header-anchor >10/02/2024 </a></h2> <p>Plan for today: Read the IR Verifier, add code to it if needed, then work on adding to SDAG node.</p> <p>IR Verifier code: It&#39;s under <code>llvm/IR/Verifier.h</code> and <code>llvm/IR/Verifier.cpp</code>.</p> <p>Ok, read the code for a bit. What I&#39;m interested in in <code>Verifier.cpp</code> is the huge switch statement towards the end of the file where the verification of intrinsics happens.</p> <p>Oh neat, learned a lot of places that probably need modification via searching <code>case Intrinsic::</code> in the llvm folder.</p> <p>Neat&#33; <code>VectorUtils.cpp</code> looks like where we add SIMD :D</p> <p>There is also a <code>SelectionDAGBuilder.cpp</code> that seems like I should update stuff there.</p> <p>Ah, seems the SDAG needs the ID node to be added to the ISDOpcodes first, like <code>ISD::SCMP</code> and such.</p> <p><a href="https://llvm.org/docs/LangRef.html#intrinsic-functions">Intrinsic Function</a>: start with <code>llvm.</code> prefix. Must always be external functions. If any are added, must be documented in LangRef. Have naming convention on type name return.</p> <p>In <code>TargetLowering.h</code>:</p> <pre><code class="julia hljs">/// This class defines information used to lower LLVM code to legal SelectionDAG
/// operators that the target instruction selector can accept natively.
///
/// This class also defines callbacks that targets must implement to lower
/// target-specific constructs to SelectionDAG operators.
class TargetLowering : public TargetLoweringBase {</code></pre> <p>Updated the PR to not include a dirty file from the <code>ValueTracking.cpp</code> unit tests.</p> <p>Sweet, rebased the <code>spaceship-intrinsic</code> branch changes into a new one.</p> <p>Now I can go for </p> <pre><code class="julia hljs">lib/CodeGen/SelectionDAG/SelectionDAG.cpp:

Add code to print the node to getOperationName. If your new node can be
evaluated at compile time when given constant arguments (such as an add of a constant with another constant), find the getNode method that takes the appropriate number of arguments, and add a case <span class=hljs-keyword >for</span> your node to the switch statement that performs constant folding <span class=hljs-keyword >for</span> nodes that take the same number of arguments as your new node.</code></pre> <p>Which gives on Line 6629 of <code>SelectionDAG.cpp</code></p> <pre><code class="julia hljs">SDValue SelectionDAG::getNode(unsigned Opcode, <span class=hljs-keyword >const</span> SDLoc &amp;DL, EVT VT,
                              SDValue N1, SDValue N2, <span class=hljs-keyword >const</span> SDNodeFlags Flags) {</code></pre> <p>where I can add an <code>case ISD::UCMP</code>/<code>case ISD::SCMP</code>. </p> <p>Oh wow, having VSCode let me just hover over a type and give me info is amazing.</p> <p>Alright, did some good work today I think.</p> <hr /> <p>Got some feedback on typo fixes from other people and some concrete directions from Nikita:</p> <pre><code class="julia hljs">def int_scmp : DefaultAttrsIntrinsic&lt;
    [llvm_anyint_ty], [llvm_anyint_ty, LLVMMatchType&lt;<span class=hljs-number >1</span>&gt;],
    [IntrNoMem, IntrSpeculatable, IntrWillReturn]&gt;;</code></pre> <p>for the <code>Intrinsics.td</code> so that we can have a &quot;result type overload over a fixed type&quot; and then </p> <blockquote> <p>and then add a check in Verifier.cpp that a&#41; the return type and the first argument type have the same number of elements &#40;if they are vectors&#41; and b&#41; the return scalar type has width at least 2.</p> </blockquote> <p>So I&#39;ve pushed a commit already to have the <code>Intrinsics.td</code> that way and I will now add a case to the <code>Verifier.cpp</code> in the <code>void Verifier::visitIntrinsicCall&#40;Intrinsic::ID ID, CallBase &amp;Call&#41; &#123;</code> to add </p> <p>&#40;Many hours later&#41; Put in a good first effort into the <code>Verifier.cpp</code> cases for <code>Intrinsic::scmp/ucmp</code>. It&#39;s probably a bit boneheaded but I&#39;ve been getting really good and fast feedback on the PRs, so I feel encouraged to keep the hot streak going.</p> <h2 id=09022024 ><a href="#09022024" class=header-anchor >09/02/2024</a></h2> <p>Lost the renaming battle to standard practices. Can&#39;t complain. Updated the PR to reflect that.</p> <p>Now, reading the <a href="https://github.com/llvm/llvm-project/blob/release/17.x/llvm/lib/Transforms/Scalar/DCE.cpp">DCE</a> pass code.</p> <p>Ok, Andrzej Warzy≈Ñski did <a href="https://www.youtube.com/watch?v&#61;ar7cJl2aBuU">an incredibly useful tutorial</a> for <code>llvm-tutor</code>.</p> <p>I&#39;ll try writing the Transformation pass, since it&#39;s closes to what I need.</p> <p>Notes: * <code>LLVM_DEBUG</code> is super useful. </p> <pre><code class="julia hljs"><span class=hljs-comment >#include &quot;llvm/ADT/Statistic.h&quot;</span>
<span class=hljs-comment >#include &quot;llvm/Support/Debug.h&quot;</span>

<span class=hljs-comment >#define DEBUG_TYPE &quot;mba-add&quot;</span>
STATISIC(SubstCount, <span class=hljs-string >&quot;The # of substituted instructions&quot;</span></code></pre> <p>and then you can do:</p> <pre><code class="julia hljs">LLVM_DEBUG(dbgs() &lt;&lt; *BinOp &lt;&lt; <span class=hljs-string >&quot; -&gt; &quot;</span> &lt;&lt; *NewInst &lt;&lt; <span class=hljs-string >&quot;\n&quot;</span>;
    // or , with Statistic and <span class=hljs-string >`-stat`</span> on the <span class=hljs-string >`opt`</span> CLI and debug build
    ++SubstCount;</code></pre> <ul> <li><p>Analysis inherits from <code>AnalysisInfoMixin</code></p> <li><p>Very common pattern:</p> </ul> <pre><code class="julia hljs"><span class=hljs-keyword >for</span> (auto &amp;Func : M) {
    <span class=hljs-keyword >for</span> (auto &amp;BB : Func) {
        <span class=hljs-keyword >for</span> (auto &amp;Ins : BB) {
            ...</code></pre> <ul> <li><p>You call <code>PreservedAnalysis.abandon&#40;&#41;</code> when you wanna bail on a logic.</p> <li><p><code>FileCheck</code> is a pattern matching tool that comes with LLVM. Can check emitted assembly output for test correctness.</p> <li><p>Rely on CMake&#39;s <code>find_package</code> and add sanity-checks to your scripts&#33;</p> <li><p>LLDB is your friend </p> </ul> <pre><code class="julia hljs">lldb -- $LLVM_DIR/bin/opt -load-pass-plugin lib/libMyPass.so -passes=my-pass -S dummy.ll
(lldb) b MyPass::run 
(lldb) r</code></pre> <p>Finally: started a branch called <code>scmp-and-ucmp</code> and I&#39;ll start trying out changes there whilst people make up their minds.</p> <h2 id=8022024 ><a href="#8022024" class=header-anchor >8/02/2024 </a></h2> <p>Jyn strikes again and sometimes you can just do <code>make</code> after <code>cmake</code> because some stuff is optional.</p> <p>Otherwise, install:</p> <pre><code class="julia hljs">sudo apt install libzstd-dev libcurl4-openssl-dev libedit-dev</code></pre>
<p>to get rolling.</p>
<p>Once you do </p>
<pre><code class="julia hljs"><span class=hljs-comment ># Run the pass</span>
$LLVM_DIR/bin/opt -load-pass-plugin ./libHelloWorld.{so|dylib} -passes=hello-world -disable-output input_for_hello.ll
<span class=hljs-comment ># Expected output</span>
(llvm-tutor) Hello from: foo
(llvm-tutor)   number of arguments: <span class=hljs-number >1</span>
(llvm-tutor) Hello from: bar
(llvm-tutor)   number of arguments: <span class=hljs-number >2</span>
(llvm-tutor) Hello from: fez
(llvm-tutor)   number of arguments: <span class=hljs-number >3</span>
(llvm-tutor) Hello from: main
(llvm-tutor)   number of arguments: <span class=hljs-number >2</span></code></pre>
<p>using <code>-disable-output</code> means no bitcode gets produced.</p>
<p>Passes come in 3 flavors, mostly: Analysis, Transformations and CFG manipulations.</p>
<p>Note that <code>clang</code> adds the <code>optnone</code> function attribute if 1&#41; no opt level is specified or <code>-O0</code> is specified. </p>
<p>Ah, forgot to run the <code>cmake .. -&gt; mold -run make -j</code> and had some passes missing. Derp.</p>
<p>Minutes lost to cmake bullshit: 60.</p>
<p>Oh sweet&#33; I just learned that I can write an injection pass that will give me a new binary and it will print out cool analysis info.</p>
<p>Also, if I get an instrumented binary I can just use <code>lli</code> to interpret the <code>.ll</code> file directly.</p>
<p>You can also build a static binary that will run that analysis for you&#33; </p>
<p>Ran a bunch of passes with <code>opt</code> and friends. Transformation passes will normally inherit from <code>PassInfoMixin</code>.</p>
<p>Analysis Passes will inherit from <code>AnalysisInfoMixin</code>.</p>
<p>Ok, cool I an outdated example in llvm-tutor <a href="https://github.com/banach-space/llvm-tutor/pull/111">in the examples</a> and sent a PR for it.</p>
<p>Tomorrow I shall dive into those optimization passes at the end and hopefully run some good <code>lit</code> tests.</p>
<h2 id=7022024 ><a href="#7022024" class=header-anchor >7/02/2024 </a></h2>
<p>Alright, did some good catchup on the semester and pushed the <a href="https://discourse.llvm.org/t/rfc-add-3-way-comparison-intrinsics/76685/7?u&#61;miguelraz">PR forward a bit</a>.</p>
<p>I also had an awesome &quot;uniwtting tourist&quot; genius moment by pointing out the return type could be different than what Nikita had thought of.</p>
<p>Today I setup my environment with</p>
<pre><code class="julia hljs">wget -O - https://apt.llvm.org/llvm-snapshot.gpg.key | sudo apt-key add -
sudo apt-add-repository <span class=hljs-string >&quot;deb http://apt.llvm.org/jammy/ llvm-toolchain-jammy-17 main&quot;</span>
sudo apt-get update
sudo apt-get install -y llvm-<span class=hljs-number >17</span> llvm-<span class=hljs-number >17</span>-dev llvm-<span class=hljs-number >17</span>-tools clang-<span class=hljs-number >17</span></code></pre>
<p>so now I can run <code>opt</code> shenanigans without awkward path invocations.</p>
<h2 id=2022024 ><a href="#2022024" class=header-anchor >2/02/2024 </a></h2>
<p>I&#39;m waiting for others to chime in on my latest fix so I will be reading on how to add <a href="https://llvm.org/docs/TestingGuide.html">unit tests</a>.</p>
<p>Cool, that took like 25 minutes and I pushed a commit into the unit test generation framework.</p>
<p>Took me a bit but tried adding using <code>llvm-lit</code> and couldn&#39;t get the <code>Examples</code> folder to run, so I posted a question in the #beginners channel about it.</p>
<h2 id=1022024 ><a href="#1022024" class=header-anchor >1/02/2024 </a></h2>
<p>Sweet&#33; I was able to address Nikita&#39;s refactoring comments without too much hassle.</p>
<p>I guess the next task is to add it to the Verifier.</p>
<p>-&gt; I read the <code>llvm/lib/IR/Verifier.cpp</code> header and grep&#39;d for <code>smin</code>. Seems I can add a </p>
<pre><code class="julia hljs">Intrinsics::vector_reduce_sthreecmp:
Intrinsics::vector_reduce_uthreecmp:</code></pre>
<p>on line 5378 and get away with this. I don&#39;t see other places where it&#39;s defined.</p>
<p>I think I&#39;ve hit my potential here. I will go do some tutorials.</p>
<h2 id=29022024 ><a href="#29022024" class=header-anchor >29/02/2024 </a></h2>
<h3 id=hazlo_cobarde ><a href="#hazlo_cobarde" class=header-anchor >&quot;hazlo cobarde&quot;</a></h3>
<p>Add the <a href="https://discourse.llvm.org/t/llvm-add-3-way-comparison-intrinsics/76807/10">3 way comparison instruction</a> <code>&lt;&#61;&gt;</code> to LLVM. </p>
<p>I like this GSoC in particular because</p>
<ul>
<li><p>I will learn a wide swath of LLVM </p>

<li><p>I&#39;ll be working with a lot of optimization passes</p>

<li><p>I&#39;ll get to bring cool perf to C&#43;&#43;/Rust and Julia</p>

<li><p>I was dared by <a href="https://twitter.com/DrawsMiguel/status/1759708211286835309">the other, more talented Miguel</a> to actually help improve LLVM</p>

</ul>
<h3 id=task_1_add_to_langref ><a href="#task_1_add_to_langref" class=header-anchor >Task 1: Add to LangRef</a></h3>
<p><a href="https://llvm.org/docs/ExtendingLLVM.html">Add a new intrinsic</a> - <code>Langref</code>, then <code>Intrinsics.td</code>, then maybe the pass verifier.</p>
<p>I&#39;ve already put up a <a href="https://github.com/llvm/llvm-project/pull/83227">sample PR</a> and got redirected on what looks like the proper working path for this endeavour.</p>
<p>Oh neat, I&#39;ve finished. Only took about 1 hour with careful copy pasting. I&#39;m probably blundering the return type being <code>iM</code> bits, but someone will correct me.</p>
<p>Now, I need to add an entry of the intrinsic into TableGen.</p>
<h3 id=task_2_add_to_intrinsicstd ><a href="#task_2_add_to_intrinsicstd" class=header-anchor >Task 2: Add to Intrinsics.td</a></h3>
<p>Whelp, I guess I gotta learn tablegen and then this <code>Intrinsics.td</code> file.</p>
<p>Ok, I found <a href="https://llvm.org/docs/TableGen/index.html">a non-intimidating TableGen overview</a>.</p>
<p>Gotta find the optimization wizardry in there after reading for a few minutes.</p>
<p>Alright, took more than a bit of an hour but <a href="https://github.com/llvm/llvm-project/pull/83227#issuecomment-1972375003">I got pushed something for this task</a>.</p>
<p>Pinged Nikita to get some adults to look at my horrible TableGen incantation.</p>
<p>See ya tomorrow.</p>
<div class=page-foot >
  <div class=copyright >
    &copy; Miguel Raz Guzm√°n Macedo. Last modified: March 14, 2024. Website built with <a href="https://github.com/tlienart/Franklin.jl">Franklin.jl</a> and the <a href="https://julialang.org">Julia programming language</a>.
 <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "efaaeb52e1314322a75ffd9edd8d1566"}'></script>
  </div>
</div>
</div>
    
    
        


	

<script>
(function(){

	// Get the elements.
	// - the 'pre' element.
	// - the 'div' with the 'paste-content' id.

	var pre = document.getElementsByTagName('pre');

	// Add a copy button in the 'pre' element.
	// which only has the className of 'language-'.

	for (var i = 0; i < pre.length; i++) {
		var isLanguage = pre[i].children[0].className.indexOf('language-');

		if ( isLanguage === 0 ) {
			var button           = document.createElement('button');
					button.className = 'copy-button';
					button.textContent = 'Copy';

					pre[i].appendChild(button);
		}
	};

	// Run Clipboard

	var copyCode = new Clipboard('.copy-button', {
		target: function(trigger) {
			return trigger.previousElementSibling;
    }
	});

	// On success:
	// - Change the "Copy" text to "Copied".
	// - Swap it to "Copy" in 2s.
	// - Lead user to the "contenteditable" area with Velocity scroll.

	copyCode.on('success', function(event) {
		event.clearSelection();
		event.trigger.textContent = 'Copied';
		window.setTimeout(function() {
			event.trigger.textContent = 'Copy';
		}, 2000);

	});

	// On error (Safari):
	// - Change the  "Press Ctrl+C to copy"
	// - Swap it to "Copy" in 2s.

	copyCode.on('error', function(event) {
		event.trigger.textContent = 'Press "Ctrl + C" to copy';
		window.setTimeout(function() {
			event.trigger.textContent = 'Copy';
		}, 5000);
	});

})();
</script>


 <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "efaaeb52e1314322a75ffd9edd8d1566"}'></script>